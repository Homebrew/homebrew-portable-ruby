name: GitHub Actions CI
on:
  push:
    branches: master
  pull_request: []
jobs:
  tests:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macOS-latest]
    steps:
    - name: Set up Git repository
      uses: actions/checkout@master

    - name: Set up Homebrew
      run: |
        brew update-reset /usr/local/Homebrew
        ln -s "$PWD" "/usr/local/Homebrew/Library/Taps/homebrew/homebrew-portable-ruby"
      if: matrix.os == 'macOS-latest'

    - name: Check Dockerfile
      run: |
        sudo npm install -g dockerfilelint
        dockerfilelint docker/Dockerfile.*
      if: matrix.os == 'ubuntu-latest'

    - name: Run brew style
      run: |
        brew style homebrew/portable-ruby
      if: matrix.os == 'macOS-latest'

    - name: Build Docker image
      run: docker build -f docker/Dockerfile.x86_64 -t homebrew-portable-x86_64 .
      if: matrix.os == 'ubuntu-latest'

    - name: Build Portable Ruby
      run: |
        if [ "$RUNNER_OS" = "Linux" ]; then
          docker run --name=homebrew-portable-ruby -w /bottle -v"$PWD":/home/linuxbrew/.linuxbrew/Homebrew/Library/Taps/homebrew/homebrew-portable-ruby homebrew-portable-x86_64 brew portable-package portable-ruby
          docker cp homebrew-portable-ruby:/bottle .
          mv bottle/* .
          rmdir bottle
        else
          brew portable-package portable-ruby
        fi

    - name: Install Portable Ruby
      run: |
        version=2.6.3
        if [ "$RUNNER_OS" = "Linux" ]; then
          prefix=/home/linuxbrew/.linuxbrew/Homebrew/Library/Homebrew/vendor
        else
          prefix=/usr/local/Homebrew/Library/Homebrew/vendor
        fi
        mkdir -p $prefix
        tar -C $prefix -xf portable-ruby--*.tar.gz
        ln -sf $version $prefix/portable-ruby/current
        echo $version >$prefix/portable-ruby-version

    - name: Test Portable Ruby
      run: |
        brew config
        brew tests
